# Lighter DEX Market Maker

This project is a complete market making solution for the Lighter DEX, built in Python. It consists of three main components that work together to collect data, calculate optimal trading parameters, and execute a market making strategy.

By default, it uses 12% of available capital per order (configurable via `CAPITAL_USAGE_PERCENT`). It can use leverage (1 by default = no leverage; for example, if your account has 100$ and you set leverage to 2, it will apply 2x leverage and use 12% of the leveraged amount ($200 * 0.12 = $24) per order.

The three core components are:
1.  **Data Collector (`gather_lighter_data.py`)**: Connects to the Lighter DEX websocket to stream real-time order book (10 levels deep) and trade data, saving it to highly compressed **Parquet** files (ZSTD).
2.  **Parameter Calculator (`calculate_avellaneda_parameters.py`)**: Implements the Avellaneda-Stoikov model to calculate optimal bid/ask spreads and reservation prices based on the collected data. It uses GARCH(1,1) for daily volatility estimation and performs grid-search optimization for time horizons.
3.  **Market Maker (`market_maker_v2.py`)**: Executes the market making strategy by placing and managing orders on the Lighter exchange, using the parameters generated by the calculator.

The entire system is orchestrated using Docker Compose, making it easy to run and manage.

Important Tips:
- Use on a dedicated account or sub-account. The bot uses 12% of available capital per order by default, and reinvests profits (compound interest).
- You don't need to have the `.env` file to run the data collector service.
- Run first the data collector service only for some time, by editing the `docker-compose.yml` (comment out the market maker service).
- To get your `ACCOUNT_INDEX`, you can go to\
   `https://mainnet.zklighter.elliot.ai/api/v1/accountsByL1Address?l1_address=0xcEd...` where `0xcEd...` is your L1 (EVM) wallet address (Metamask, Rabby, Ledger, ...).
- Freshly coded, probably some bugs, only run with small amount of funds.

## Quick Start

### Prerequisites
*   Python 3.10+
*   Docker
*   Docker Compose

### Installation

Before running the bot, you need to install the required Python packages:

```bash
pip install -r requirements.txt
```

### Configuration

1.  **Create `.env` file:** Create a `.env` file in the root of the project. See `.env.example` for a template.

    ```env
    # Lighter Exchange Credentials
    API_KEY_PRIVATE_KEY=<your_api_key_private_key>
    ACCOUNT_INDEX=<your_account_index>
    API_KEY_INDEX=<your_api_key_index>

    # Market Maker Behavior
    MARKET_SYMBOL=PAXG
    ```

2.  **Configure Tickers (`config.json`):**
    Edit `config.json` to specify which markets to track and global model parameters.
    ```json
    {
        "CRYPTO_TICKERS": ["ETH", "PAXG"],
        "GAMMA": 0.5
    }
    ```
    *   `CRYPTO_TICKERS`: List of symbols to collect data for.
    *   `GAMMA`: Fixed dimensionless risk aversion parameter. Defaults to 0.05 if omitted. Higher values (e.g., 0.5) make the bot more risk-averse with wider spreads

3.  **Environment Variables:**
    *   `API_KEY_PRIVATE_KEY`, `ACCOUNT_INDEX`, `API_KEY_INDEX`: Your Lighter exchange credentials.
    *   `MARKET_SYMBOL`: The market to trade on (e.g., PAXG, BTC, ETH). Defaults to `PAXG`.
    *   `CLOSE_LONG_ON_STARTUP`: (true/false) If true, the bot will attempt to close any existing long position in the specified market on startup. Defaults to `false`.
    *   `REQUIRE_PARAMS`: (true/false) If true, the market maker will *not* place any orders until valid Avellaneda parameters are calculated. If false, it will use a fallback spread of 0.1% (mid_price × 0.001). Defaults to `false`.
    *   `RESTART_INTERVAL_MINUTES`: The market maker service automatically restarts after a timeout. In docker-compose, this is set via `timeout 600` (10 minutes) with `RESTART_SECONDS=5` controlling the delay between restarts. This helps reload parameters and prevent memory leaks
    *   `LEVERAGE`: The amount of leverage to use (e.g., 1, 2, 5, 8). This value multiplies your available capital, allowing for larger position sizes. Defaults to `1` (no leverage). Set to `2` for 2x leverage, `5` for 5x leverage, etc.
    *   `MARGIN_MODE`: The margin mode to use, either `cross` or `isolated`. This is also configured in `docker-compose.yml`. Defaults to `cross`.
    *   `FLIP`: (true/false) If true, the bot will adopt a short-biased strategy, selling first and then buying back. If false, it will follow a long-biased strategy, buying first and then selling. Defaults to `false`.
    *   `CAPITAL_USAGE_PERCENT`: (decimal) The percentage of available capital to use per order. Set in the code as `0.12` (12%). This controls position sizing - with 12%, each order uses that fraction of your available leveraged capital. Lower values = smaller positions, higher values = larger positions.

You can obtain the API credentials from the Lighter exchange.

### Running the Bot

Start all services using Docker Compose:
```bash
docker-compose build
docker-compose up -d
```

By default, only the data collector service runs. The parameter calculator and market maker services are commented out for safety:
*   `lighter-data-collector`: Gathers real-time market data (active by default).
*   `parameter-calculator`: Calculates optimal spreads and reservation prices (commented out - requires data collection first). When enabled, runs every 60 seconds (`INTERVAL_SECONDS=60`) analyzing the last 15 minutes of data (`--minutes 15`).
*   `market-maker`: Executes the trading strategy (commented out - requires parameters and user configuration). When enabled, runs with a 10-minute timeout (`timeout 600`) and restarts with 5-second delay between attempts.

### Stopping the Bot

To stop all services, run:
```bash
docker-compose down
```

## Example Output

Here is an example of the market maker logs in action:

![Market Maker Logs](screen.png)

## Project Structure

```
.
├── docker-compose.yml
├── Dockerfile
├── config.json                     # Ticker and Gamma configuration
├── requirements.txt
├── .env.example
├── gather_lighter_data.py          # Data collector (WebSocket -> Parquet)
├── calculate_avellaneda_parameters.py  # Parameter calculator (main)
├── market_maker_v2.py              # Execution engine
├── utils.py                        # Shared utilities
├── volatility.py                   # GARCH volatility estimation
├── intensity.py                    # Order intensity calculation
├── backtest.py                     # Parameter optimization and backtesting
├── test_runner.py                  # Testing utilities
├── check_parquet.py                # Data validation tool
├── lighter_data/                   # Parquet output data (prices_*.parquet, trades_*.parquet)
├── params/                         # JSON output from the parameter calculator
├── logs/                           # Log files for all services
├── DOC/                            # Documentation
└── OLD/                            # Legacy code and examples
```

## How it Works

### 1. Data Collection

The `gather_lighter_data.py` script connects to the Lighter DEX websocket and subscribes to the order book and trade channels for the configured markets (e.g., 'ETH', 'PAXG'). It captures **10 levels of order book depth** and saves this data to efficient, ZSTD-compressed **Parquet** files in the `lighter_data` directory. It handles deduplication and gap detection automatically.

### 2. Parameter Calculation

The `calculate_avellaneda_parameters.py` script runs periodically (default: every 60 seconds, analyzing the last 15 minutes of data, configurable via `INTERVAL_SECONDS` and `--minutes` parameters). It loads the recent high-frequency data from the Parquet files to calculate:
*   **Volatility ($\sigma$)**: Uses a **GARCH(1,1)** model on 1-second resampled mid-prices to estimate daily volatility, with fallback to rolling standard deviation if GARCH fails.
*   **Order Intensity ($A, k$)**: Fits an exponential decay function to order arrival times across different spread depths. Calculates separate values for bid and ask sides (`A_bid`, `k_bid`, `A_ask`, `k_ask`).
*   **Risk Aversion ($\gamma$)**: Uses a fixed configuration value from `config.json` (default 0.05 if not specified). The value determines spread width - higher values create wider spreads for more conservative trading

The calculated parameters are saved to `params/avellaneda_parameters_{TICKER}.json`.

### 3. Market Making

The `market_maker_v2.py` script reads the parameters from the JSON files. It connects to the Lighter exchange and places limit orders:
*   **Reservation Price ($r$)**: Adjusted from the mid-price based on current inventory, volatility, and risk aversion ($r = s - q \gamma \sigma^2 T$).
*   **Optimal Spread**: Calculated using the Avellaneda-Stoikov model with separate bid/ask parameters. When parameters are unavailable and `REQUIRE_PARAMS=false`, uses a fallback spread of 0.1% of mid-price.
*   **Static Fallback Values**: If parameters aren't available, the code defines `SPREAD = 0.035%` and `BASE_AMOUNT = 0.047`, but these are only used when dynamic sizing is disabled.

**Capital Management**: The bot uses a conservative approach to capital allocation with the following formula for each order:
```
Order Size = Available Capital × (1 - Safety Margin) × Leverage × Capital Usage Percent
           = Available Capital × 0.99 × Leverage × 0.12
```
- `SAFETY_MARGIN_PERCENT = 0.01` (retains 1% buffer)
- `CAPITAL_USAGE_PERCENT = 0.12` (uses 12% per order)
- Example with defaults: $100 × 0.99 × 1 × 0.12 = $11.88 per order
- With 2x leverage: $100 × 0.99 × 2 × 0.12 = $23.76 per order

---

**⚠️ Risk Warning**: This trading software will likely lose money, even if it generates significant volume, because it isn’t competitive with professional firms. Always start with small amounts and make sure you understand the risks of automated cryptocurrency trading.
